#
# Example Sphinx Configuration for London Stage Database
#
# This file should be placed on the server hosting Sphinx to be used by the
# Sphinx `indexer` and `searchd` programs.
#

source main
{
    # Update the MySQL connection info below!
    type            = mysql
    sql_host        = mysqlhost.example.com # can be localhost
    sql_user        = londonstagedbuser
    sql_pass        = areallysecurepassword1A!
    sql_db          = London
    sql_port        = 3306  # optional, default is 3306
    # Stop editing here.
    # Additional configuration to update can be found in the next Source definition.
    sql_query_pre   = SET @a := 1;
    sql_query       = \
        SELECT \
          @a := @a + 1 AS id, \
          Events.EventId eventid, \
          Events.EventDate eventdate, \
          Events.Season season, \
          Events.Hathi hathi, \
          Events.commentC commentc, \
          Events.CommentCClean commentcclean, \
          Events.theatreId theatreid, \
          Performances.PerformanceId performanceid, \
          Performances.PerformanceOrder performanceorder, \
          Performances.PType ptype, \
          Performances.PerformanceTitle performancetitle, \
          Performances.PerfTitleClean perftitleclean, \
          Performances.CommentP commentp, \
          Performances.CommentPClean commentpclean, \
          Performances.CastAsListed castaslisted, \
          Performances.DetailedComment detailedcomment, \
          Cast.CastId castid, \
          Cast.Role role, \
          Cast.RoleClean roleclean, \
          Cast.PerformerClean performerclean, \
          Cast.Performer performer, \
          Theatre.Volume volume, \
          Theatre.TheatreName theatrename, \
          Works.WorkId workid, \
          Author.AuthId authid, \
          Author.AuthName authname, \
          Author.AuthNameClean authnameclean \
        FROM Events \
          LEFT JOIN Performances ON Performances.EventId = Events.EventId \
          LEFT JOIN Cast ON Cast.PerformanceId = Performances.PerformanceId \
          LEFT JOIN Theatre ON Theatre.TheatreId = Events.TheatreId \
          LEFT JOIN Works ON Works.WorkId = Performances.WorkId \
          LEFT JOIN WorkAuthMaster on WorkAuthMaster.WorkId = Works.WorkId \
          LEFT JOIN Author on Author.AuthId = WorkAuthMaster.AuthId \
          LEFT JOIN WorksVariant ON WorksVariant.WorkId = Works.WorkId
    sql_field_string = commentcclean
    sql_field_string = perftitleclean
    sql_field_string = performancetitle
    sql_field_string = commentpclean
    sql_field_string = roleclean
    sql_field_string = performerclean
    sql_field_string = authnameclean
    sql_attr_uint    = eventid
    sql_attr_uint    = eventdate
    sql_attr_string  = season
    sql_attr_string  = hathi
    sql_attr_string  = commentc
    sql_attr_uint    = theatreid
    sql_attr_uint    = performanceid
    sql_attr_uint    = performanceorder
    sql_attr_string  = ptype
    sql_attr_string  = commentp
    sql_attr_string  = castaslisted
    sql_attr_string  = detailedcomment
    sql_attr_uint    = castid
    sql_attr_string  = role
    sql_attr_string  = performer
    sql_attr_uint    = volume
    sql_attr_string  = theatrename
    sql_attr_uint    = workid
    sql_attr_uint    = authid
    sql_attr_string  = authname
}

source related_work
{
    # Update the MySQL connection info below!
    type            = mysql
    sql_host        = mysqlhost.example.com # can be localhost
    sql_user        = londonstagedbuser
    sql_pass        = areallysecurepassword1A!
    sql_db          = London
    sql_port        = 3306  # optional, default is 3306
    # Stop editing here.
    # Additional configuration to update can be found in the inxex section, below.
    sql_query       = \
        SELECT ROW_NUMBER() OVER () AS id, sq.* \
        FROM ( \
            SELECT DISTINCTROW \
                Works.WorkId AS WorkId, \
                Works.Title AS Title, \
                Works.PubDate AS PubDate, \
                Works.Source1 AS Source1, \
                Works.Source2 AS Source2, \
                Works.SourceResearched AS SourceResearched, \
                WorksVariant.VariantName AS VariantName, \
                WorkAuthFiltered.AuthType AS AuthType, \
                Author.AuthId AS AuthId, \
                Author.AuthName AS AuthName, \
                Author.StartDate AS StartDate, \
                Author.StartType AS StartType, \
                Author.EndDate AS EndDate, \
                Author.EndType AS EndType, \
                PerfFiltered.PerformanceTitle AS PerformanceTitle \
            FROM Works \
                LEFT JOIN WorksVariant \
                ON Works.WorkId = WorksVariant.WorkId \
                LEFT JOIN ( \
                SELECT * FROM WorkAuthMaster \
                WHERE AuthType LIKE "Primary" \
                    OR AuthType LIKE "Researched" \
                ) AS WorkAuthFiltered \
                ON Works.WorkId = WorkAuthFiltered.WorkId \
                LEFT JOIN Author \
                ON WorkAuthFiltered.AuthId = Author.AuthId \
                LEFT JOIN ( \
                SELECT DISTINCT Works.WorkId, Performances.PerformanceTitle \
                FROM Performances \
                INNER JOIN Works \
                    ON Works.WorkId = Performances.WorkId \
                WHERE LOWER(Works.Title) != LOWER(Performances.PerformanceTitle) \
                GROUP BY Works.WorkId \
                ) AS PerfFiltered \
                ON Works.WorkId = PerfFiltered.WorkId \
            ) AS sq
    sql_attr_uint = workid
    sql_field_string = title
    sql_attr_uint = pubdate
    sql_field_string = source1
    sql_field_string = source2
    sql_field_string = sourceresearched
    sql_field_string = variantname
    sql_attr_string = authtype
    sql_attr_uint = authid
    sql_field_string = authname
    sql_attr_string = startdate
    sql_attr_string = starttype
    sql_attr_string = enddate
    sql_attr_string = endtype
    sql_field_string = performancetitle
}


index london_stages
{
    source          = main
    morphology      = lemmatize_en
    expand_keywords = 1
    # Update the path info below, if needed.
    # A different directory can be entered for index files to be located.
    path            = /opt/sphinx/index/london_stages
    # The location of the stopwords file should be entered below.
    stopwords       = /opt/sphinx/conf/stopwords.txt
        # Unicode character mapping settings
    charset_table = 0..9, A..Z->a..z, a..z, \
                    U+00C2->A, U+00C3->A, \
                    U+00C9->E, \
                    U+00E0->a, U+00E1->a, U+00E2->a, U+00E4->a, U+00E5->a, \
                    U+00E7->c, \
                    U+00E8->e, U+00E9->e, U+00EA->e, \
                    U+00EE->i, U+00EF->i, \
                    U+00F2->o, U+00F3->o, U+00F4->o, U+00F5->o, U+00F6->o, \
                    U+00F9->u, U+00FC->u, U+00FA->u
    # Stop editing here.
    # Additional configuration to update can be found in the next inxex section.
}

index related_work
{
    source          = related_work
    morphology      = lemmatize_en
    # Update the path info below, if needed.
    # A different directory can be entered for index files to be located.
    path            = /opt/sphinx/index/related_work
    # The location of the stopwords file should be entered below.
    stopwords       = /opt/sphinx/conf/stopwords.txt
        # Unicode character mapping settings
    charset_table = 0..9, A..Z->a..z, a..z, \
                    U+00C2->A, U+00C3->A, \
                    U+00C9->E, \
                    U+00E0->a, U+00E1->a, U+00E2->a, U+00E4->a, U+00E5->a, \
                    U+00E7->c, \
                    U+00E8->e, U+00E9->e, U+00EA->e, \
                    U+00EE->i, U+00EF->i, \
                    U+00F2->o, U+00F3->o, U+00F4->o, U+00F5->o, U+00F6->o, \
                    U+00F9->u, U+00FC->u, U+00FA->u
    # Stop editing here.
    # Additional configuration to update can be found in the next inxex section.
}

index real_time_index
{
    type            = rt
    rt_mem_limit    = 256M
    morphology      = lemmatize_en
    # Update the path info below, if needed.
    # A different directory can be entered for index files to be located.
    path            = /opt/sphinx/index/real_time_index
    # The location of the stopwords file should be entered below.
    stopwords       = /opt/sphinx/conf/stopwords.txt
    # Stop editing here.
    # Additional configuration to update can be found in the searchd section below.
    rt_field        = commentcclean
    rt_field        = perftitleclean
    rt_field        = performancetitle
    rt_field        = commentpclean
    rt_field        = roleclean
    rt_field        = performerclean
    rt_field        = authnameclean
    rt_attr_uint    = eventdate
    rt_attr_string  = season
    rt_attr_string  = hathi
    rt_attr_string  = commentc
    rt_attr_uint    = theatreid
    rt_attr_uint    = performanceid
    rt_attr_uint    = performanceorder
    rt_attr_string  = ptype
    rt_attr_string  = commentp
    rt_attr_string  = castaslisted
    rt_attr_string  = detailedcomment
    rt_attr_uint    = castid
    rt_attr_string  = role
    rt_attr_string  = performer
    rt_attr_uint    = volume
    rt_attr_string  = theatrename
    rt_attr_uint    = workid
    rt_attr_uint    = authid
    rt_attr_string  = authname
}


indexer
{
    mem_limit       = 512M
}


searchd
{
    # Update the configuration below, if needed.
    # A different port can be entered for Sphinx to listen to.
    listen          = 9312      # SPHINX_PORT in db.php
    listen          = 9306:mysql41
    # A different directory can be used for the log and query_log.
    log             = /opt/sphinx/log/searchd.log
    query_log       = /opt/sphinx/log/query.log
    # A different directory can be used to store the pid file.
    pid_file        = /opt/sphinx/data/searchd.pid
    # Only update the configuration below if the engine needs to be optimized.
    binlog_path     = /opt/sphinx/data
    read_timeout    = 5
    max_children    = 30
    workers         = threads # for real_time_index to work
    # Stop editing here.
    # Additional configuration to update can be found in the common section below.
    seamless_rotate = 1
    preopen_indexes = 1
    unlink_old      = 1
}

common
{
    # Update the location of the en.pak file on the Sphinx server. See setup for more info.
    lemmatizer_base = /opt/sphinx/conf/dicts
    # Stop editing here.
    # There is no additional configuration to update.
}
